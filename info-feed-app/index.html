<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æƒ…å ±åé›†ãƒ„ãƒ¼ãƒ« <span style="font-size: 0.7em; color: #666;">Ver.0.6.1</span></title>
  
  <!-- PWAç”¨ãƒ¡ã‚¿ã‚¿ã‚° -->
  <link rel="manifest" href="manifest.json">
  
  <!-- iOS Safariå¯¾å¿œ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="æƒ…å ±åé›†ãƒ„ãƒ¼ãƒ«">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
  
  <!-- Android Chromeå¯¾å¿œ -->
  <meta name="theme-color" content="#007cba">
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #333;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 2rem;
      border-bottom: 2px solid #ddd;
    }
    
    .tab {
      padding: 0.5rem 1rem;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      border-bottom-color: #007cba;
      color: #007cba;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Feedç®¡ç† */
    .feed-form {
      margin-bottom: 2rem;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    
    .feed-form input {
      width: 70%;
      padding: 0.5rem;
      margin-right: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    .feed-form button {
      padding: 0.5rem 1rem;
      background-color: #007cba;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .feed-list {
      list-style: none;
      padding: 0;
    }
    
    .feed-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    
    .feed-item button {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
    }
    
    /* è¨˜äº‹è¡¨ç¤º */
    .controls {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    
    .controls button {
      padding: 0.5rem 1rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .section {
      margin-bottom: 2rem;
    }
    
    .section h2 {
      margin-top: 2rem;
      font-size: 1.5rem;
      color: #333;
      border-bottom: 2px solid #ddd;
      padding-bottom: 0.5rem;
    }
    
    .article {
      margin-bottom: 1rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    
    .article h3 {
      margin: 0 0 0.5rem;
      font-size: 1.1rem;
    }
    
    .article a {
      text-decoration: none;
      color: #007cba;
    }
    
    .article a:hover {
      text-decoration: underline;
    }
    
    .article p {
      margin: 0.5rem 0;
      color: #666;
    }
    
    .article .meta {
      font-size: 0.9rem;
      color: #888;
      margin: 0.5rem 0;
    }
    
    .article .actions {
      margin-top: 0.5rem;
      display: flex;
      gap: 0.5rem;
    }
    
    .article button {
      font-size: 0.8rem;
      padding: 0.3rem 0.6rem;
      border: 1px solid #999;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .read-button {
      background-color: #28a745;
      color: white;
      border-color: #28a745;
    }
    
    .summary-button {
      background-color: #007cba;
      color: white;
      border-color: #007cba;
    }

    .producthunt-summary-button {
      background-color: #da552f;
      color: white;
      border-color: #da552f;
    }
    
    .summary-button:disabled {
      background-color: #6c757d;
      border-color: #6c757d;
      cursor: not-allowed;
    }
    
    .summary {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background-color: #e9ecef;
      border-radius: 4px;
      border-left: 4px solid #007cba;
    }
    
    .transcript-status {
      font-size: 0.8rem;
      margin-left: 0.5rem;
      padding: 0.2rem 0.4rem;
      border-radius: 3px;
      background-color: #f8f9fa;
    }
    
    .error-message {
      margin-top: 0.5rem;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .loading {
      color: #6c757d;
      font-style: italic;
    }
    
    .error {
      color: #dc3545;
    }
    
    .progress-indicator {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007cba;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal {
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 0;
      border: none;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      color: #333;
    }
    
    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
    }
    
    .modal-body {
      padding: 1rem;
    }
    
    .modal-body textarea {
      width: 100%;
      margin: 1rem 0;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
      resize: vertical;
    }
    
    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1rem;
    }
    
    .modal-actions button {
      padding: 0.5rem 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      background-color: white;
    }
    
    .modal-actions button.primary {
      background-color: #007cba;
      color: white;
      border-color: #007cba;
    }
    
    .manual-summary-button {
      background-color: #28a745;
      color: white;
      border-color: #28a745;
    }
    
    /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .progress-container {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background-color: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #007cba;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #007cba, #28a745);
      border-radius: 4px;
      transition: width 0.3s ease;
      animation: progress-animation 2s infinite;
    }
    
    @keyframes progress-animation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .progress-text {
      font-size: 0.9rem;
      color: #495057;
      display: flex;
      align-items: center;
    }
    
    .progress-text::before {
      content: '';
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #007cba;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>æƒ…å ±åé›†ãƒ„ãƒ¼ãƒ« <small style="font-size: 0.6em; color: #666;">Ver.0.6.1</small></h1>
  
  <div class="tabs">
    <button class="tab active" onclick="switchTab('articles')">è¨˜äº‹ä¸€è¦§</button>
    <button class="tab" onclick="switchTab('feeds')">Feedç®¡ç†</button>
  </div>
  
  <!-- è¨˜äº‹ä¸€è¦§ã‚¿ãƒ– -->
  <div id="articles-tab" class="tab-content active">
    <div class="controls">
      <button onclick="refreshArticles()">è¨˜äº‹ã‚’æ›´æ–°</button>
      <button onclick="refreshProductHunt()" style="background-color: #da552f;">
        ğŸš€ Product Huntæ›´æ–°
      </button>
      <label>
        <input type="checkbox" id="unread-only" checked onchange="loadArticles(false)">
        æœªèª­ã®ã¿è¡¨ç¤º
      </label>
    </div>
    <div id="articles-container"></div>
  </div>
  
  <!-- Feedç®¡ç†ã‚¿ãƒ– -->
  <div id="feeds-tab" class="tab-content">
    <div class="feed-form">
      <h3>RSS Feed ã‚’è¿½åŠ </h3>
      <input type="url" id="feed-url" placeholder="RSS Feed URL ã‚’å…¥åŠ›">
      <button onclick="addFeed()">è¿½åŠ </button>
    </div>
    
    <h3>ç™»éŒ²æ¸ˆã¿Feed</h3>
    <ul id="feeds-list" class="feed-list"></ul>
  </div>

  <!-- æ‰‹å‹•è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="manual-summary-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>æ‰‹å‹•ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã§è¦ç´„</h3>
        <span class="close" onclick="closeManualSummaryModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p>å‹•ç”»ã‚„è¨˜äº‹ã®å†…å®¹ã‚’ä¸‹è¨˜ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚AIãŒè¦ç´„ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
        <textarea id="manual-text-input" placeholder="å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." rows="8"></textarea>
        <div class="modal-actions">
          <button onclick="closeManualSummaryModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button onclick="submitManualSummary()" class="primary">è¦ç´„ã‚’ä½œæˆ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API Base URL ã®è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã¨ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«å¯¾å¿œï¼‰
    const API_BASE = window.location.origin.includes('localhost') || 
                     window.location.origin.includes('127.0.0.1') ? 
                     '' : // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯ç›¸å¯¾ãƒ‘ã‚¹
                     window.location.origin; // æœ¬ç•ªç’°å¢ƒã§ã¯ãƒ•ãƒ«ãƒ‘ã‚¹
    
    console.log('ğŸ”§ API_BASE configured:', API_BASE);
    console.log('ğŸ”§ Current origin:', window.location.origin);
    
    // æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ‡å®šæ–‡å­—æ•°ã§åˆ‡ã‚Šæ¨ã¦ã‚‹é–¢æ•°
    function truncateText(text, maxLength = 100) {
      if (!text || typeof text !== 'string') return '';
      
      // æ—¥æœ¬èªæ–‡å­—ã‚’æ•°ãˆã‚‹ï¼ˆå…¨è§’æ–‡å­—ãƒ»åŠè§’æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰
      if (text.length <= maxLength) {
        return text;
      }
      
      // maxLengthæ–‡å­—ã§åˆ‡ã‚Šæ¨ã¦ã€æœ€å¾Œã«ã€Œ...ã€ã‚’è¿½åŠ 
      const truncated = text.substring(0, maxLength);
      
      // æ–‡ã®é€”ä¸­ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã«ã€å¯èƒ½ãªã‚‰å¥ç‚¹ã§åˆ‡ã‚‹
      const lastPunctuation = Math.max(
        truncated.lastIndexOf('ã€‚'),
        truncated.lastIndexOf('ã€'),
        truncated.lastIndexOf('ï¼'),
        truncated.lastIndexOf('ï¼Ÿ'),
        truncated.lastIndexOf('.'),
        truncated.lastIndexOf(','),
        truncated.lastIndexOf('!'),
        truncated.lastIndexOf('?')
      );
      
      if (lastPunctuation > maxLength * 0.7) {
        // å¥ç‚¹ãŒ70%ä»¥é™ã«ã‚ã‚‹å ´åˆã¯ãã“ã§åˆ‡ã‚‹
        return truncated.substring(0, lastPunctuation + 1) + '...';
      } else {
        // ãã†ã§ãªã‘ã‚Œã°ãã®ã¾ã¾åˆ‡ã‚‹
        return truncated + '...';
      }
    }
    
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
      
      if (tabName === 'articles') {
        loadArticles();
      } else if (tabName === 'feeds') {
        loadFeeds();
      }
    }
    
    // è¨˜äº‹ä¸€è¦§ã®èª­ã¿è¾¼ã¿
    let currentOffset = 0;
    const articlesPerPage = 25;  // è¤‡æ•°Feedç™»éŒ²æ™‚ã§ã‚‚ååˆ†ãªè¡¨ç¤ºæ•°ã‚’ç¢ºä¿
    
    async function loadArticles(loadMore = false) {
      const unreadOnly = document.getElementById('unread-only').checked;
      const container = document.getElementById('articles-container');
      
      if (!loadMore) {
        currentOffset = 0;
        container.innerHTML = '';
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/articles?unread_only=${unreadOnly}&limit=${articlesPerPage}&offset=${currentOffset}`);
        const data = await response.json();
        
        if (data.articles.length === 0) {
          if (currentOffset === 0) {
            container.innerHTML = '<p>è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</p>';
          }
          return;
        }
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¿ã‚¤ãƒ—ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const typeLabels = {
          'youtube': 'YouTubeå‹•ç”»',
          'podcast': 'Podcast',
          'producthunt': 'Product Hunt',
          'article': 'Webè¨˜äº‹'
        };
        
        if (loadMore) {
          // è¿½åŠ èª­ã¿è¾¼ã¿ã®å ´åˆã€æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«è¿½åŠ 
          data.articles.forEach(article => {
            const existingSection = container.querySelector(`[data-type="${article.content_type}"]`);
            if (existingSection) {
              const articleEl = createArticleElement(article);
              existingSection.appendChild(articleEl);
            } else {
              // æ–°ã—ã„ã‚¿ã‚¤ãƒ—ã®å ´åˆã¯æ–°ã—ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
              const section = document.createElement('div');
              section.className = 'section';
              section.dataset.type = article.content_type;
              
              const header = document.createElement('h2');
              header.textContent = typeLabels[article.content_type] || article.content_type;
              section.appendChild(header);
              
              const articleEl = createArticleElement(article);
              section.appendChild(articleEl);
              
              container.appendChild(section);
            }
          });
        } else {
          // åˆå›èª­ã¿è¾¼ã¿ã®å ´åˆ
          Object.entries(data.grouped).forEach(([type, articles]) => {
            const section = document.createElement('div');
            section.className = 'section';
            section.dataset.type = type;
            
            const header = document.createElement('h2');
            header.textContent = typeLabels[type] || type;
            section.appendChild(header);
            
            articles.forEach(article => {
              const articleEl = createArticleElement(article);
              section.appendChild(articleEl);
            });
            
            container.appendChild(section);
          });
        }
        
        currentOffset += data.articles.length;
        
        // ã€Œã‚‚ã£ã¨è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
        updateLoadMoreButton(data.articles.length === articlesPerPage);
        
      } catch (error) {
        console.error('Error loading articles:', error);
        if (currentOffset === 0) {
          container.innerHTML = '<p class="error">è¨˜äº‹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
        }
      }
    }
    
    function updateLoadMoreButton(hasMore) {
      let loadMoreBtn = document.getElementById('load-more-btn');
      
      if (hasMore) {
        if (!loadMoreBtn) {
          loadMoreBtn = document.createElement('button');
          loadMoreBtn.id = 'load-more-btn';
          loadMoreBtn.textContent = 'ã‚‚ã£ã¨è¦‹ã‚‹';
          loadMoreBtn.style.cssText = 'display: block; margin: 20px auto; padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer;';
          loadMoreBtn.onclick = () => loadArticles(true);
          
          const container = document.getElementById('articles-container');
          container.parentNode.insertBefore(loadMoreBtn, container.nextSibling);
        }
        loadMoreBtn.style.display = 'block';
      } else {
        if (loadMoreBtn) {
          loadMoreBtn.style.display = 'none';
        }
      }
    }
    
    // è¨˜äº‹è¦ç´ ã®ä½œæˆ
    function createArticleElement(article) {
      const div = document.createElement('div');
      div.className = 'article';
      div.dataset.id = article.id;
      
      const pubDate = new Date(article.pub_date).toLocaleDateString('ja-JP');
      
      div.innerHTML = `
        <h3><a href="${article.link}" target="_blank">${article.title}</a></h3>
        <p>${truncateText(article.description || '', 100)}</p>
        <div class="meta">
          ${article.feed_title} / ${pubDate}
          ${article.content_type === 'youtube' ? '<span class="transcript-status" id="transcript-status-' + article.id + '">ğŸ” ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç¢ºèªä¸­...</span>' : ''}
        </div>
        <div class="actions">
          <button class="read-button" onclick="markAsRead(${article.id})">
            âœ“ æ—¢èª­ã«ã™ã‚‹
          </button>
          ${article.content_type === 'youtube' ? 
            `<button class="youtube-summary-button" id="youtube-summary-btn-${article.id}" onclick="requestYouTubeSummary(${article.id})" 
                     ${article.summary_status === 'processing' ? 'disabled' : ''}>
              ğŸ¬ å‹•ç”»è¦ç´„
            </button>` : ''}
          ${article.content_type === 'podcast' ? 
            `<button class="audio-summary-button" id="audio-summary-btn-${article.id}" onclick="requestAudioSummary(${article.id})" 
                     ${article.summary_status === 'processing' ? 'disabled' : ''}>
              ğŸ§ éŸ³å£°è¦ç´„
            </button>` : ''}
          ${article.content_type === 'producthunt' ? 
            `<button class="producthunt-summary-button" id="producthunt-summary-btn-${article.id}" onclick="requestManualSummary(${article.id})" 
                     ${article.summary_status === 'processing' ? 'disabled' : ''}>
              ğŸš€ ã‚¢ãƒ—ãƒªè¦ç´„
            </button>
            <a href="${article.link}" target="_blank" class="producthunt-link" style="text-decoration: none;">
              <button style="background-color: #da552f; color: white; margin-left: 0.5rem;">
                ğŸ”— Product Hunt
              </button>
            </a>` : ''}
          <button class="manual-summary-button" onclick="showManualSummaryModal(${article.id})">
            âœï¸ æ‰‹å‹•è¦ç´„
          </button>
        </div>
        ${article.summary_text ? `<div class="summary">${truncateText(article.summary_text, 100)}</div>` : ''}
        <div class="progress-container" id="progress-container-${article.id}" style="display: none;">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill-${article.id}"></div>
          </div>
          <div class="progress-text" id="progress-text-${article.id}">å‡¦ç†ä¸­...</div>
        </div>
        <div class="error-message" id="error-message-${article.id}" style="display: none;"></div>
      `;
      
      // YouTubeå‹•ç”»ã®å ´åˆã¯å­—å¹•ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
      if (article.content_type === 'youtube') {
        checkTranscriptAvailability(article.id);
      }
      
      return div;
    }
    
    function getSummaryButtonText(status) {
      switch (status) {
        case 'pending': return 'è¦ç´„ã‚’ä½œæˆ';
        case 'processing': return 'è¦ç´„ä¸­...';
        case 'completed': return 'è¦ç´„å®Œäº†';
        case 'failed': return 'è¦ç´„å¤±æ•—';
        default: return 'è¦ç´„ã‚’ä½œæˆ';
      }
    }
    
    // æ—¢èª­ãƒãƒ¼ã‚¯
    async function markAsRead(articleId) {
      try {
        const response = await fetch(`${API_BASE}/api/articles/${articleId}/read`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ read_status: true })
        });
        
        if (response.ok) {
          const articleEl = document.querySelector(`[data-id="${articleId}"]`);
          if (articleEl) {
            articleEl.remove();
          }
        }
      } catch (error) {
        console.error('Error marking as read:', error);
      }
    }
    
    // éŸ³å£°è¦ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–¢æ•°ã‚’è¿½åŠ 
    async function requestAudioSummary(articleId) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
      const confirmed = confirm('éŸ³å£°ã‹ã‚‰ã®è¦ç´„ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»å‡¦ç†æ™‚é–“: 3-5åˆ†ç¨‹åº¦\nãƒ»APIã‚³ã‚¹ãƒˆãŒç™ºç”Ÿã—ã¾ã™\nãƒ»é€”ä¸­ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã§ãã¾ã›ã‚“');
      
      if (!confirmed) {
        return;
      }
      
      const button = document.getElementById(`audio-summary-btn-${articleId}`);
      const progressContainer = document.getElementById(`progress-container-${articleId}`);
      const progressText = document.getElementById(`progress-text-${articleId}`);
      const progressFill = document.getElementById(`progress-fill-${articleId}`);
      const errorContainer = document.getElementById(`error-message-${articleId}`);
      
      try {
        // UIæ›´æ–°
        button.disabled = true;
        button.textContent = 'éŸ³å£°å‡¦ç†ä¸­...';
        progressContainer.style.display = 'block';
        errorContainer.style.display = 'none';
        
        // éŸ³å£°è¦ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        const response = await fetch(`${API_BASE}/api/articles/${articleId}/summarize`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ audio_summary: true })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          // é€²è¡ŒçŠ¶æ³ã‚’ç›£è¦–
          monitorAudioSummaryProgress(articleId);
        } else {
          throw new Error(data.error || 'éŸ³å£°è¦ç´„ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
      } catch (error) {
        console.error('Audio summary error:', error);
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        errorContainer.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        errorContainer.style.display = 'block';
        progressContainer.style.display = 'none';
        
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        button.disabled = false;
        button.textContent = 'ğŸ§ éŸ³å£°è¦ç´„';
      }
    }
    
    // YouTubeå‹•ç”»è¦ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–¢æ•°
    async function requestYouTubeSummary(articleId) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèª
      const confirmed = confirm('YouTubeå‹•ç”»ã®è¦ç´„ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ»å­—å¹•ãŒã‚ã‚‹å ´åˆ: 1-2åˆ†ç¨‹åº¦\nãƒ»å­—å¹•ãŒãªã„å ´åˆ: 3-5åˆ†ç¨‹åº¦ï¼ˆéŸ³å£°å‡¦ç†ï¼‰\nãƒ»APIã‚³ã‚¹ãƒˆãŒç™ºç”Ÿã—ã¾ã™\nãƒ»é€”ä¸­ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã§ãã¾ã›ã‚“');
      
      if (!confirmed) {
        return;
      }
      
      const button = document.getElementById(`youtube-summary-btn-${articleId}`);
      const progressContainer = document.getElementById(`progress-container-${articleId}`);
      const errorContainer = document.getElementById(`error-message-${articleId}`);
      
      try {
        // UIæ›´æ–°
        button.disabled = true;
        button.textContent = 'å‹•ç”»å‡¦ç†ä¸­...';
        progressContainer.style.display = 'block';
        errorContainer.style.display = 'none';
        
        // YouTubeè¦ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        const response = await fetch(`${API_BASE}/api/articles/${articleId}/summarize`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ youtube_summary: true })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          // é€²è¡ŒçŠ¶æ³ã‚’ç›£è¦–
          monitorYouTubeSummaryProgress(articleId);
        } else {
          throw new Error(data.error || 'YouTubeè¦ç´„ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
      } catch (error) {
        console.error('YouTube summary error:', error);
        
        // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        let errorMessage = error.message;
        if (errorMessage.includes('HTTP 404')) {
          errorMessage = 'è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        } else if (errorMessage.includes('HTTP 500')) {
          errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚';
        } else if (errorMessage.includes('fetch')) {
          errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        }
        
        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        errorContainer.textContent = `ã‚¨ãƒ©ãƒ¼: ${errorMessage}`;
        errorContainer.style.display = 'block';
        progressContainer.style.display = 'none';
        
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        button.disabled = false;
        button.textContent = 'ğŸ¬ å‹•ç”»è¦ç´„';
      }
    }
    
    // éŸ³å£°è¦ç´„é€²è¡ŒçŠ¶æ³ç›£è¦–
    async function monitorAudioSummaryProgress(articleId) {
      const progressText = document.getElementById(`progress-text-${articleId}`);
      const progressFill = document.getElementById(`progress-fill-${articleId}`);
      const button = document.getElementById(`audio-summary-btn-${articleId}`);
      
      const stages = [
        { text: 'éŸ³å£°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...', progress: 20 },
        { text: 'éŸ³å£°è»¢å†™ä¸­...', progress: 60 },
        { text: 'è¦ç´„ç”Ÿæˆä¸­...', progress: 90 }
      ];
      
      let currentStage = 0;
      
      const updateProgress = () => {
        if (currentStage < stages.length) {
          const stage = stages[currentStage];
          progressText.textContent = stage.text;
          progressFill.style.width = stage.progress + '%';
          currentStage++;
        }
      };
      
      // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®š
      updateProgress();
      
      // å®šæœŸçš„ã«é€²è¡ŒçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
      const progressInterval = setInterval(updateProgress, 10000); // 10ç§’ã”ã¨
      
      // çµæœã‚’ãƒãƒ¼ãƒªãƒ³ã‚°
      const checkResult = async () => {
        try {
          const response = await fetch(`${API_BASE}/api/articles/${articleId}/summary`);
          const data = await response.json();
          
          if ((data.request_status === 'completed' || data.summary_status === 'completed') && data.summary_text) {
            clearInterval(progressInterval);
            
            // æˆåŠŸæ™‚ã®UIæ›´æ–°
            progressText.textContent = 'è¦ç´„å®Œäº†ï¼';
            progressFill.style.width = '100%';
            
            setTimeout(() => {
              document.getElementById(`progress-container-${articleId}`).style.display = 'none';
              
              const articleEl = document.querySelector(`[data-id="${articleId}"]`);
              if (articleEl) {
                let summaryDiv = articleEl.querySelector('.summary');
                if (!summaryDiv) {
                  summaryDiv = document.createElement('div');
                  summaryDiv.className = 'summary';
                  const actionsDiv = articleEl.querySelector('.actions');
                  actionsDiv.insertAdjacentElement('afterend', summaryDiv);
                }
                // æ”¹è¡Œã‚’<br>ã«å¤‰æ›ã—ã¦ã‚µãƒãƒªãƒ¼å…¨ä½“ã‚’è¡¨ç¤º
                summaryDiv.innerHTML = data.summary_text.replace(/\n/g, '<br>');
              }
              
              // ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
              if (button) {
                button.textContent = 'è¦ç´„å®Œäº†';
                button.disabled = true;
              }
            }, 1000);
            
          } else if (data.request_status === 'failed' || data.summary_status === 'failed') {
            clearInterval(progressInterval);
            
            // å¤±æ•—æ™‚ã®UIæ›´æ–°
            const errorContainer = document.getElementById(`error-message-${articleId}`);
            errorContainer.textContent = `ã‚¨ãƒ©ãƒ¼: ${data.error || 'éŸ³å£°è¦ç´„ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
            errorContainer.style.display = 'block';
            document.getElementById(`progress-container-${articleId}`).style.display = 'none';
            
            button.disabled = false;
            button.textContent = 'ğŸ§ éŸ³å£°è¦ç´„';
          } else {
            // ã¾ã å‡¦ç†ä¸­ã®å ´åˆã€ç¶™ç¶šã—ã¦ãƒã‚§ãƒƒã‚¯
            setTimeout(checkResult, 5000); // 5ç§’å¾Œã«å†ãƒã‚§ãƒƒã‚¯
          }
          
        } catch (error) {
          console.error('Progress check error:', error);
          setTimeout(checkResult, 10000); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯10ç§’å¾Œã«å†è©¦è¡Œ
        }
      };
      
      // åˆå›ãƒã‚§ãƒƒã‚¯ã‚’å°‘ã—é…ã‚‰ã›ã¦å®Ÿè¡Œ
      setTimeout(checkResult, 3000);
    }
    
    // YouTubeå‹•ç”»è¦ç´„é€²è¡ŒçŠ¶æ³ç›£è¦–
    async function monitorYouTubeSummaryProgress(articleId) {
      const progressText = document.getElementById(`progress-text-${articleId}`);
      const progressFill = document.getElementById(`progress-fill-${articleId}`);
      const button = document.getElementById(`youtube-summary-btn-${articleId}`);
      
      const stages = [
        { text: 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç¢ºèªä¸­...', progress: 10 },
        { text: 'å­—å¹•å–å¾—ä¸­...', progress: 30 },
        { text: 'éŸ³å£°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...', progress: 50 },
        { text: 'éŸ³å£°æ–‡å­—èµ·ã“ã—ä¸­...', progress: 70 },
        { text: 'è¦ç´„ç”Ÿæˆä¸­...', progress: 90 }
      ];
      
      let currentStage = 0;
      const startTime = Date.now();
      const MAX_TIMEOUT = 10 * 60 * 1000; // 10åˆ†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      
      const updateProgress = () => {
        if (currentStage < stages.length) {
          const stage = stages[currentStage];
          progressText.textContent = stage.text;
          progressFill.style.width = stage.progress + '%';
          currentStage++;
        }
      };
      
      // åˆæœŸã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®š
      updateProgress();
      
      // å®šæœŸçš„ã«é€²è¡ŒçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
      const progressInterval = setInterval(updateProgress, 15000); // 15ç§’ã”ã¨
      
      // çµæœã‚’ãƒãƒ¼ãƒªãƒ³ã‚°
      const checkResult = async () => {
        try {
          // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯
          const elapsed = Date.now() - startTime;
          if (elapsed > MAX_TIMEOUT) {
            clearInterval(progressInterval);
            
            console.log('â° YouTube summary timed out after', elapsed/1000, 'seconds');
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã®UIæ›´æ–°
            const errorContainer = document.getElementById(`error-message-${articleId}`);
            if (errorContainer) {
              errorContainer.textContent = 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: å‡¦ç†æ™‚é–“ãŒé•·ã™ãã¾ã™ã€‚ã€Œæ‰‹å‹•è¦ç´„ã€ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚';
              errorContainer.style.display = 'block';
            }
            
            document.getElementById(`progress-container-${articleId}`).style.display = 'none';
            
            if (button) {
              button.disabled = false;
              button.textContent = 'ğŸ¬ å‹•ç”»è¦ç´„';
            }
            return;
          }
          
          const response = await fetch(`${API_BASE}/api/articles/${articleId}/summary`);
          const data = await response.json();
          
          console.log('ğŸ” YouTube summary check result:', data); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
          console.log('ğŸ” Detailed status check:', {
            summary_status: data.summary_status,
            request_status: data.request_status,
            has_summary_text: !!data.summary_text,
            summary_text_length: data.summary_text ? data.summary_text.length : 0,
            error_message: data.error_message,
            timestamp: new Date().toISOString(),
            elapsed_seconds: elapsed/1000
          });
          
          // æˆåŠŸæ¡ä»¶ã‚’ã‚ˆã‚Šå³å¯†ã«ãƒã‚§ãƒƒã‚¯
          const isCompleted = data.summary_status === 'completed' || data.request_status === 'completed';
          const hasSummaryText = data.summary_text && data.summary_text.trim().length > 0;
          
          if (isCompleted && hasSummaryText) {
            clearInterval(progressInterval);
            
            // æˆåŠŸæ™‚ã®UIæ›´æ–°
            progressText.textContent = 'è¦ç´„å®Œäº†ï¼';
            progressFill.style.width = '100%';
            
            // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã‚’éè¡¨ç¤ºã«ã™ã‚‹
            const errorContainer = document.getElementById(`error-message-${articleId}`);
            if (errorContainer) {
              errorContainer.style.display = 'none';
            }
            
            setTimeout(() => {
              document.getElementById(`progress-container-${articleId}`).style.display = 'none';
              
              const articleEl = document.querySelector(`[data-id="${articleId}"]`);
              if (articleEl) {
                let summaryDiv = articleEl.querySelector('.summary');
                if (!summaryDiv) {
                  summaryDiv = document.createElement('div');
                  summaryDiv.className = 'summary';
                  const actionsDiv = articleEl.querySelector('.actions');
                  actionsDiv.insertAdjacentElement('afterend', summaryDiv);
                }
                // æ”¹è¡Œã‚’<br>ã«å¤‰æ›ã—ã¦ã‚µãƒãƒªãƒ¼å…¨ä½“ã‚’è¡¨ç¤º
                summaryDiv.innerHTML = data.summary_text.replace(/\n/g, '<br>');
              }
              
              // ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
              if (button) {
                button.textContent = 'è¦ç´„å®Œäº†';
                button.disabled = true;
              }
            }, 1000);
            
          } else if (data.request_status === 'failed' || data.summary_status === 'failed') {
            clearInterval(progressInterval);
            
            console.log('âŒ YouTube summary failed:', {
              request_status: data.request_status,
              summary_status: data.summary_status,
              error_message: data.error_message,
              methods_attempted: data.methods || 'unknown'
            });
            
            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            const errorContainer = document.getElementById(`error-message-${articleId}`);
            if (errorContainer) {
              errorContainer.textContent = `ã‚¨ãƒ©ãƒ¼: ${data.error_message || 'YouTubeè¦ç´„ã«å¤±æ•—ã—ã¾ã—ãŸ'}`;
              errorContainer.style.display = 'block';
            }
            
            document.getElementById(`progress-container-${articleId}`).style.display = 'none';
            
            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            if (button) {
              button.disabled = false;
              button.textContent = 'ğŸ¬ å‹•ç”»è¦ç´„';
            }
          } else if (data.summary_status === 'pending' || data.request_status === 'pending' || 
                     data.summary_status === 'processing' || data.request_status === 'processing') {
            // ã¾ã å‡¦ç†ä¸­ - æ¬¡å›ãƒã‚§ãƒƒã‚¯
            setTimeout(checkResult, 8000); // 8ç§’ã«çŸ­ç¸®
          } else {
            // äºˆæœŸã—ãªã„çŠ¶æ…‹
            console.warn('Unexpected summary status:', data);
            setTimeout(checkResult, 10000);
          }
        } catch (error) {
          console.error('YouTube summary progress check error:', error);
          setTimeout(checkResult, 10000); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯10ç§’å¾Œã«å†è©¦è¡Œ
        }
      };
      
      // åˆå›ãƒã‚§ãƒƒã‚¯ã‚’å°‘ã—é…ã‚‰ã›ã¦å®Ÿè¡Œ
      setTimeout(checkResult, 3000);
    }
    
    // YouTube ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
    async function checkTranscriptAvailability(articleId) {
      try {
        const response = await fetch(`${API_BASE}/api/articles/${articleId}/content-check`);
        const data = await response.json();
        
        const statusElement = document.getElementById(`transcript-status-${articleId}`);
        const summaryButton = document.getElementById(`summary-btn-${articleId}`);
        
        if (statusElement) {
          if (data.available) {
            const methodText = data.methods && data.methods.length > 0 ? 
              (data.methods.includes('transcript') ? 'ğŸ“„ å­—å¹•åˆ©ç”¨å¯èƒ½' : 'ğŸ“ èª¬æ˜æ–‡åˆ©ç”¨å¯èƒ½') : 
              'âœ… è¦ç´„å¯èƒ½';
            statusElement.textContent = methodText;
            statusElement.style.color = '#28a745';
          } else {
            statusElement.textContent = 'âŒ è¦ç´„ä¸å¯';
            statusElement.style.color = '#dc3545';
            if (summaryButton) {
              summaryButton.disabled = true;
              summaryButton.textContent = 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãªã—ï¼ˆè¦ç´„ä¸å¯ï¼‰';
            }
          }
        }
      } catch (error) {
        console.error('Content check failed:', error);
        const statusElement = document.getElementById(`transcript-status-${articleId}`);
        if (statusElement) {
          statusElement.textContent = 'â“ ç¢ºèªå¤±æ•—';
          statusElement.style.color = '#6c757d';
        }
      }
    }

    // è¦ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    async function requestSummary(articleId) {
      console.log(`ğŸ¬ Starting requestSummary for article ${articleId}`);
      
      const button = document.getElementById(`summary-btn-${articleId}`);
      const errorElement = document.getElementById(`error-message-${articleId}`);
      const progressContainer = document.getElementById(`progress-container-${articleId}`);
      
      console.log(`ğŸ” UI elements found:`, {
        hasButton: !!button,
        hasErrorElement: !!errorElement,
        hasProgressContainer: !!progressContainer
      });
      
      try {
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éš ã™
        if (errorElement) {
          errorElement.style.display = 'none';
          console.log(`ğŸ—‘ï¸ Hidden error element for article ${articleId}`);
        }
        
        console.log(`ğŸ“¡ Sending POST request to /api/articles/${articleId}/summarize`);
        const response = await fetch(`${API_BASE}/api/articles/${articleId}/summarize`, {
          method: 'POST'
        });
        
        console.log(`ğŸ“¡ Summary request response: ${response.status} ${response.statusText}`);
        
        if (response.ok) {
          const responseData = await response.json();
          console.log(`âœ… Summary request successful:`, responseData);
          
          if (button) {
            button.disabled = true;
            button.textContent = 'è¦ç´„ä¸­...';
            console.log(`ğŸ”˜ Button updated for article ${articleId}: disabled=true, text='è¦ç´„ä¸­...'`);
          }
          
          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’è¡¨ç¤º
          console.log(`ğŸ“Š Showing progress for article ${articleId}`);
          showProgress(articleId, 'è¦ç´„å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...');
          
          // è¦ç´„å®Œäº†ã‚’å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
          console.log(`ğŸ”„ Starting polling for article ${articleId}`);
          checkSummaryProgress(articleId);
          console.log(`âœ… checkSummaryProgress called for article ${articleId}`);
        } else {
          const errorData = await response.json();
          console.log(`âŒ Summary request failed:`, errorData);
          showError(articleId, errorData.error || 'è¦ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error(`âŒ Error in requestSummary for article ${articleId}:`, error);
        showError(articleId, 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }
    
    // è¦ç´„é€²è¡ŒçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
    async function checkSummaryProgress(articleId, attempts = 0) {
      console.log(`ğŸš€ Starting checkSummaryProgress for article ${articleId}, attempt ${attempts + 1}`);
      
      if (attempts > 30) { // æœ€å¤§30å›ï¼ˆç´„5åˆ†ï¼‰
        console.log(`â° Timeout reached for article ${articleId} after ${attempts} attempts`);
        hideProgress(articleId);
        showError(articleId, 'è¦ç´„å‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
        return;
      }
      
      try {
        console.log(`ğŸ“¡ Fetching summary status for article ${articleId}...`);
        const response = await fetch(`${API_BASE}/api/articles/${articleId}/summary`);
        console.log(`ğŸ“¡ Response status: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å¼·åŒ–
        console.log(`ğŸ” Full API response for article ${articleId}:`, data);
        console.log(`ğŸ” Detailed checking summary for article ${articleId} (attempt ${attempts + 1}):`, {
          summary_status: data.summary_status,
          request_status: data.request_status,
          has_summary_text: !!data.summary_text,
          summary_length: data.summary_text ? data.summary_text.length : 0,
          error_message: data.error_message,
          request_created: data.request_created,
          request_completed: data.request_completed
        });
        
        // æ¡ä»¶ãƒã‚§ãƒƒã‚¯ã®è©³ç´°ãƒ­ã‚°
        const isRequestCompleted = data.request_status === 'completed';
        const isSummaryCompleted = data.summary_status === 'completed';
        const hasSummaryText = !!data.summary_text;
        
        console.log(`ğŸ” Condition check:`, {
          isRequestCompleted,
          isSummaryCompleted,
          hasSummaryText,
          condition1: isRequestCompleted || isSummaryCompleted,
          finalCondition: (isRequestCompleted || isSummaryCompleted) && hasSummaryText
        });
        
        if ((isRequestCompleted || isSummaryCompleted) && hasSummaryText) {
          // è¦ç´„å®Œäº†
          console.log(`âœ… Summary completion detected for article ${articleId}!`);
          console.log(`âœ… Summary preview:`, data.summary_text.substring(0, 50) + '...');
          
          try {
            hideProgress(articleId);
            updateProgress(articleId, 100, 'è¦ç´„å®Œäº†ï¼');
            console.log(`ğŸ‰ Progress updated to 100% for article ${articleId}`);
            
            setTimeout(() => {
              console.log(`ğŸ”„ Displaying summary in-place for article ${articleId}`);
              hideProgress(articleId);
              
              // æ—¢å­˜ã®è¨˜äº‹è¦ç´ ã‚’è¦‹ã¤ã‘ã¦ã€ãã®å ´ã§è¦ç´„ã‚’è¡¨ç¤º
              const articleEl = document.querySelector(`[data-id="${articleId}"]`);
              if (articleEl) {
                // æ—¢å­˜ã®è¦ç´„ã‚¨ãƒªã‚¢ã‚’æ¢ã™
                let summaryDiv = articleEl.querySelector('.summary');
                if (!summaryDiv) {
                  // è¦ç´„ã‚¨ãƒªã‚¢ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°ã—ãä½œæˆ
                  summaryDiv = document.createElement('div');
                  summaryDiv.className = 'summary';
                  
                  // actionsã®å¾Œã«æŒ¿å…¥
                  const actionsDiv = articleEl.querySelector('.actions');
                  if (actionsDiv) {
                    actionsDiv.insertAdjacentElement('afterend', summaryDiv);
                  }
                }
                
                // è¦ç´„å†…å®¹ã‚’è¡¨ç¤ºï¼ˆæ”¹è¡Œã‚’<br>ã«å¤‰æ›ï¼‰
                summaryDiv.innerHTML = data.summary_text.replace(/\n/g, '<br>');
                console.log(`ğŸ“„ Summary displayed in-place for article ${articleId}`);
                
                // è¦ç´„ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                const button = document.getElementById(`summary-btn-${articleId}`);
                if (button) {
                  button.textContent = 'è¦ç´„å®Œäº†';
                  button.disabled = true;
                }
                
                // éŸ³å£°è¦ç´„ãƒœã‚¿ãƒ³ã‚‚æ›´æ–°
                const audioButton = document.getElementById(`audio-summary-btn-${articleId}`);
                if (audioButton) {
                  audioButton.textContent = 'è¦ç´„å®Œäº†';
                  audioButton.disabled = true;
                }
              } else {
                // è¨˜äº‹è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å¾“æ¥é€šã‚Šãƒªãƒ­ãƒ¼ãƒ‰
                console.log(`ğŸ”„ Article element not found, reloading articles for ${articleId}`);
                loadArticles();
              }
            }, 1000);
          } catch (uiError) {
            console.error(`âŒ UI update error for article ${articleId}:`, uiError);
          }
          
        } else if (data.request_status === 'failed' || data.summary_status === 'failed') {
          // è¦ç´„å¤±æ•—
          console.log(`âŒ Summary failed for article ${articleId}:`, data.error_message);
          hideProgress(articleId);
          showError(articleId, data.error_message || 'è¦ç´„å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
          const button = document.getElementById(`summary-btn-${articleId}`);
          if (button) {
            button.disabled = false;
            button.textContent = 'è¦ç´„ã‚’å†è©¦è¡Œ';
          }
        } else {
          // ã¾ã å‡¦ç†ä¸­ - ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
          console.log(`â³ Still processing article ${articleId}, will check again in 10 seconds...`);
          const progressText = getProgressText(attempts);
          const progressValue = Math.min(90, (attempts / 30) * 90);
          updateProgress(articleId, progressValue, progressText);
          
          console.log(`â° Setting timeout for next check of article ${articleId} in 10 seconds`);
          setTimeout(() => {
            console.log(`â° Timeout triggered, calling checkSummaryProgress again for article ${articleId}`);
            checkSummaryProgress(articleId, attempts + 1);
          }, 10000);
        }
      } catch (error) {
        console.error(`âŒ Error checking summary progress for article ${articleId}:`, error);
        console.log(`â° Setting retry timeout for article ${articleId} in 10 seconds due to error`);
        setTimeout(() => {
          console.log(`â° Error retry timeout triggered for article ${articleId}`);
          checkSummaryProgress(articleId, attempts + 1);
        }, 10000);
      }
    }
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
    function showProgress(articleId, text) {
      console.log(`ğŸ“Š showProgress called for article ${articleId} with text: "${text}"`);
      const progressContainer = document.getElementById(`progress-container-${articleId}`);
      if (progressContainer) {
        progressContainer.style.display = 'block';
        console.log(`ğŸ“Š Progress container shown for article ${articleId}`);
        updateProgress(articleId, 10, text);
      } else {
        console.error(`âŒ Progress container not found for article ${articleId}`);
      }
    }
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
    function updateProgress(articleId, percentage, text) {
      console.log(`ğŸ“Š updateProgress called for article ${articleId}: ${percentage}%, "${text}"`);
      const progressFill = document.getElementById(`progress-fill-${articleId}`);
      const progressText = document.getElementById(`progress-text-${articleId}`);
      
      if (progressFill) {
        progressFill.style.width = `${percentage}%`;
        console.log(`ğŸ“Š Progress fill updated to ${percentage}% for article ${articleId}`);
      } else {
        console.error(`âŒ Progress fill element not found for article ${articleId}`);
      }
      
      if (progressText) {
        progressText.textContent = text;
        console.log(`ğŸ“Š Progress text updated to "${text}" for article ${articleId}`);
      } else {
        console.error(`âŒ Progress text element not found for article ${articleId}`);
      }
    }
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹éè¡¨ç¤º
    function hideProgress(articleId) {
      console.log(`ğŸ“Š hideProgress called for article ${articleId}`);
      const progressContainer = document.getElementById(`progress-container-${articleId}`);
      if (progressContainer) {
        progressContainer.style.display = 'none';
        console.log(`ğŸ“Š Progress container hidden for article ${articleId}`);
      } else {
        console.error(`âŒ Progress container not found for hideProgress for article ${articleId}`);
      }
    }
    
    // é€²è¡ŒçŠ¶æ³ã«å¿œã˜ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
    function getProgressText(attempts) {
      if (attempts < 5) {
        return 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’åˆ†æä¸­...';
      } else if (attempts < 10) {
        return 'éŸ³å£°ã‚’å‡¦ç†ä¸­...';
      } else if (attempts < 20) {
        return 'AIè¦ç´„ã‚’ç”Ÿæˆä¸­...';
      } else {
        return 'æœ€çµ‚å‡¦ç†ä¸­...';
      }
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showError(articleId, message) {
      const errorElement = document.getElementById(`error-message-${articleId}`);
      if (errorElement) {
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹å–„ã—ã¦è¡¨ç¤º
        let improvedMessage = message;
        
        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ä»£æ›¿æ¡ˆã‚’æç¤º
        if (message.includes('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™') || message.includes('Audio file too large')) {
          improvedMessage += '\n\nğŸ’¡ å¯¾å‡¦æ³•ï¼š\nãƒ»ã‚ˆã‚ŠçŸ­ã„éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãŠè©¦ã—ãã ã•ã„\nãƒ»æ‰‹å‹•è¦ç´„æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„';
        }
        
        // RSS feedã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ä»£æ›¿æ¡ˆã‚’æç¤º
        if (message.includes('RSS Feed') || message.includes('RSS')) {
          improvedMessage += '\n\nğŸ’¡ å¯¾å‡¦æ³•ï¼š\nãƒ»æ‰‹å‹•è¦ç´„æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„\nãƒ»ç›´æ¥éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«URLãŒã‚ã‚‹å ´åˆã¯ãã¡ã‚‰ã‚’ãŠè©¦ã—ãã ã•ã„';
        }
        
        // Whisper APIã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ä»£æ›¿æ¡ˆã‚’æç¤º
        if (message.includes('éŸ³å£°èªè­˜') || message.includes('è»¢å†™')) {
          improvedMessage += '\n\nğŸ’¡ å¯¾å‡¦æ³•ï¼š\nãƒ»éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å“è³ªã‚’ç¢ºèªã—ã¦ãã ã•ã„\nãƒ»æ‰‹å‹•è¦ç´„æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„';
        }
        
        errorElement.innerHTML = improvedMessage.replace(/\n/g, '<br>');
        errorElement.style.display = 'block';
        errorElement.style.color = '#dc3545';
        errorElement.style.backgroundColor = '#f8d7da';
        errorElement.style.border = '1px solid #f5c6cb';
        errorElement.style.borderRadius = '4px';
        errorElement.style.padding = '0.5rem';
        errorElement.style.marginTop = '0.5rem';
        errorElement.style.fontSize = '0.9rem';
        errorElement.style.lineHeight = '1.4';
      }
    }
    
    // è¨˜äº‹æ›´æ–°
    async function refreshArticles() {
      try {
        const response = await fetch(`${API_BASE}/api/feeds/refresh`, {
          method: 'POST'
        });
        
        if (response.ok) {
          const data = await response.json();
          alert(`${data.processedCount} å€‹ã®Feedã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
          
          // è¨˜äº‹ä¸€è¦§ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ–°ã—ã„è¨˜äº‹ã®ã¿ã‚’èª­ã¿è¾¼ã¿
          const container = document.getElementById('articles-container');
          container.innerHTML = '';
          currentOffset = 0;
          
          // æœªèª­è¨˜äº‹ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ONã«ã™ã‚‹
          const unreadOnlyCheckbox = document.getElementById('unread-only');
          if (unreadOnlyCheckbox) {
            unreadOnlyCheckbox.checked = true;
          }
          
          loadArticles();
        }
      } catch (error) {
        console.error('Error refreshing articles:', error);
      }
    }

    // Product Huntæ›´æ–°
    async function refreshProductHunt() {
      try {
        const button = event.target;
        button.disabled = true;
        button.textContent = 'ğŸ”„ æ›´æ–°ä¸­...';
        
        const response = await fetch(`${API_BASE}/api/feeds/refresh-producthunt`, {
          method: 'POST'
        });
        
        if (response.ok) {
          const data = await response.json();
          alert(`Product Huntæ›´æ–°å®Œäº†: ${data.newApps} å€‹ã®æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
          
          // è¨˜äº‹ä¸€è¦§ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰æ–°ã—ã„è¨˜äº‹ã®ã¿ã‚’èª­ã¿è¾¼ã¿
          const container = document.getElementById('articles-container');
          container.innerHTML = '';
          currentOffset = 0;
          
          // æœªèª­è¨˜äº‹ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã«ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ONã«ã™ã‚‹
          const unreadOnlyCheckbox = document.getElementById('unread-only');
          if (unreadOnlyCheckbox) {
            unreadOnlyCheckbox.checked = true;
          }
          
          loadArticles();
        } else {
          const errorData = await response.json();
          let errorMessage = 'Unknown error';
          
          if (response.status === 503 && errorData.message && errorData.message.includes('token not configured')) {
            errorMessage = `Product Hunt APIè¨­å®šã‚¨ãƒ©ãƒ¼:\n\n${errorData.message}\n\nè¨­å®šæ‰‹é †:\n1. https://api.producthunt.com/v2/docs ã«ã‚¢ã‚¯ã‚»ã‚¹\n2. ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã¦API tokenã‚’å–å¾—\n3. .envãƒ•ã‚¡ã‚¤ãƒ«ã«PRODUCTHUNT_API_TOKENã‚’è¨­å®š`;
          } else if (response.status === 401) {
            errorMessage = `Product Hunt APIèªè¨¼ã‚¨ãƒ©ãƒ¼:\n\n${errorData.message}\n\nAPI tokenãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
          } else if (response.status === 429) {
            errorMessage = `Product Hunt APIãƒ¬ãƒ¼ãƒˆåˆ¶é™:\n\n${errorData.message}\n\næ•°åˆ†å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`;
          } else if (response.status === 503 && errorData.message && errorData.message.includes('Cannot connect')) {
            errorMessage = `Product Hunt APIæ¥ç¶šã‚¨ãƒ©ãƒ¼:\n\n${errorData.message}\n\nã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
          } else {
            errorMessage = `Product Huntæ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:\n\n${errorData.message || errorData.error || 'Unknown error'}`;
          }
          
          alert(errorMessage);
        }
      } catch (error) {
        console.error('Error refreshing Product Hunt:', error);
        alert('Product Huntæ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      } finally {
        const button = event.target;
        button.disabled = false;
        button.textContent = 'ğŸš€ Product Huntæ›´æ–°';
      }
    }
    
    // Feedç®¡ç†
    async function loadFeeds() {
      try {
        const response = await fetch(`${API_BASE}/api/feeds`);
        const feeds = await response.json();
        
        const list = document.getElementById('feeds-list');
        list.innerHTML = '';
        
        feeds.forEach(feed => {
          const li = document.createElement('li');
          li.className = 'feed-item';
          li.innerHTML = `
            <div>
              <strong>${feed.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</strong><br>
              <small>${feed.url}</small>
            </div>
            <button onclick="deleteFeed(${feed.id})">å‰Šé™¤</button>
          `;
          list.appendChild(li);
        });
      } catch (error) {
        console.error('Error loading feeds:', error);
      }
    }
    
    async function addFeed() {
      const url = document.getElementById('feed-url').value.trim();
      if (!url) {
        alert('RSS Feed URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      // URLã®åŸºæœ¬çš„ãªå¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
      try {
        new URL(url);
      } catch (e) {
        alert('æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      // ã‚ˆã‚Šå…·ä½“çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’å›é¿
      const addButton = document.querySelector('.feed-form button[onclick="addFeed()"]') || 
                       document.querySelector('.feed-form button');
      const originalText = addButton.textContent;
      
      console.log('ğŸš€ Starting feed addition:', url);
      console.log('ğŸ”§ Button found:', !!addButton);
      
      if (!addButton) {
        alert('ã‚¨ãƒ©ãƒ¼: è¿½åŠ ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      try {
        // UIã‚’æ›´æ–°ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‡¦ç†ä¸­ã‚’ç¤ºã™
        addButton.disabled = true;
        addButton.textContent = 'å‡¦ç†ä¸­...';
        
        console.log('ğŸ“¡ Sending POST request to /api/feeds');
        console.log('ğŸ“¡ API_BASE:', API_BASE);
        console.log('ğŸ“¡ Full URL:', `${API_BASE}/api/feeds`);
        
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šï¼ˆ30ç§’ï¼‰
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          controller.abort();
          console.log('â° Request aborted due to timeout');
        }, 30000);
        
        const response = await fetch(`${API_BASE}/api/feeds`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        console.log('ğŸ“¡ Response received:', response.status, response.statusText);
        
        if (response.ok) {
          const result = await response.json();
          console.log('âœ… Feed addition successful:', result);
          
          document.getElementById('feed-url').value = '';
          loadFeeds();
          
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è©³ç´°ã«è¡¨ç¤º
          const articleCount = result.articlesAdded || 0;
          const message = `âœ… ${result.title || 'Feed'}ã‚’è¿½åŠ ã—ã¾ã—ãŸ\nğŸ“„ ${articleCount}ä»¶ã®è¨˜äº‹ã‚’å–å¾—`;
          alert(message);
          
        } else {
          const error = await response.json();
          console.error('âŒ Feed addition error:', error);
          console.error('Full error response:', {
            status: response.status,
            statusText: response.statusText,
            error: error
          });
          
          let errorMessage = '';
          if (response.status === 400) {
            errorMessage = `âŒ ç„¡åŠ¹ãªRSS Feed URL\n\nè©³ç´°: ${error.error || 'URLã‚’ç¢ºèªã—ã¦ãã ã•ã„'}`;
          } else if (response.status === 409) {
            errorMessage = `â„¹ï¸ ã“ã®Feedã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™\n\nå‰Šé™¤æ¸ˆã¿ã®Feedã‚’å†ç™»éŒ²ã—ãŸã„å ´åˆã¯ã€åŒã˜URLã‚’å†åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`;
          } else if (response.status === 500) {
            errorMessage = `âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\nè©³ç´°: ${error.error || 'ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„'}\n\nURL: ${url}`;
          } else {
            errorMessage = `âŒ Feedè¿½åŠ ã‚¨ãƒ©ãƒ¼ (${response.status})\n\nè©³ç´°: ${error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}\n\nURL: ${url}`;
          }
          
          alert(errorMessage);
        }
      } catch (error) {
        console.error('âŒ Network error adding feed:', error);
        console.error('Error details:', {
          message: error.message,
          name: error.name,
          stack: error.stack
        });
        
        let networkErrorMessage = 'âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ\n\n';
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          networkErrorMessage += 'åŸå› : ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“\n';
          networkErrorMessage += 'å¯¾å‡¦: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„';
        } else if (error.name === 'AbortError') {
          networkErrorMessage += 'åŸå› : ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆ30ç§’ï¼‰\n';
          networkErrorMessage += 'å¯¾å‡¦: RSS ãƒ•ã‚£ãƒ¼ãƒ‰ã®å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚\n';
          networkErrorMessage += 'ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã™ã‚‹ã‹ã€åˆ¥ã®ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ãŠè©¦ã—ãã ã•ã„';
        } else {
          networkErrorMessage += `è©³ç´°: ${error.message}\n`;
          networkErrorMessage += `ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: ${error.name}\n`;
          networkErrorMessage += `URL: ${url}\n`;
          networkErrorMessage += 'ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„';
        }
        
        alert(networkErrorMessage);
      } finally {
        // UIã‚’å…ƒã«æˆ»ã™
        addButton.disabled = false;
        addButton.textContent = originalText;
        console.log('ğŸ”„ Feed addition process completed');
      }
    }
    
    async function deleteFeed(feedId) {
      if (!confirm('ã“ã®Feedã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      try {
        const response = await fetch(`${API_BASE}/api/feeds/${feedId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          loadFeeds();
        }
      } catch (error) {
        console.error('Error deleting feed:', error);
      }
    }
    
    // æ‰‹å‹•è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    let currentArticleId = null;
    
    function showManualSummaryModal(articleId) {
      currentArticleId = articleId;
      const modal = document.getElementById('manual-summary-modal');
      const textInput = document.getElementById('manual-text-input');
      
      textInput.value = '';
      modal.style.display = 'block';
      textInput.focus();
    }
    
    function closeManualSummaryModal() {
      const modal = document.getElementById('manual-summary-modal');
      modal.style.display = 'none';
      currentArticleId = null;
    }
    
    async function submitManualSummary() {
      const textInput = document.getElementById('manual-text-input');
      const manualText = textInput.value.trim();
      
      if (!manualText) {
        alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      if (!currentArticleId) {
        alert('ã‚¨ãƒ©ãƒ¼: è¨˜äº‹IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/api/articles/${currentArticleId}/summarize`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ manual_text: manualText })
        });
        
        if (response.ok) {
          closeManualSummaryModal();
          
          // è¦ç´„å‡¦ç†ä¸­ã®è¡¨ç¤ºã‚’æ›´æ–°
          const button = document.getElementById(`summary-btn-${currentArticleId}`);
          if (button) {
            button.disabled = true;
            button.textContent = 'è¦ç´„ä¸­...';
          }
          
          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’è¡¨ç¤º
          showProgress(currentArticleId, 'æ‰‹å‹•ãƒ†ã‚­ã‚¹ãƒˆã‚’å‡¦ç†ä¸­...');
          
          // é€²è¡ŒçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
          checkSummaryProgress(currentArticleId);
          
        } else {
          const errorData = await response.json();
          alert(`ã‚¨ãƒ©ãƒ¼: ${errorData.error || 'è¦ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'}`);
        }
      } catch (error) {
        console.error('Error submitting manual summary:', error);
        alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      }
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.onclick = function(event) {
      const modal = document.getElementById('manual-summary-modal');
      if (event.target === modal) {
        closeManualSummaryModal();
      }
    }
    
    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadArticles();
    });
  </script>
</body>
</html>